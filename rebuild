: '
rebuild
Created by Willem Van Zwol, last edited 2025.02.25

The purpose of this script is to automate and streamline the process of modifying nixos configuration and rebuilding
'

#!/usr/bin/env bash

set -e

origin=$(pwd)
time_file="/home/willemvz/Programs/nixscripts/nixos-rebuild-time.txt"

cd /etc/nixos

sudo -E nvim packages.nix # Edit config with sudo

sudo alejandra /etc/nixos/configuration.nix &>/dev/null  # Format it

sudo git -C /etc/nixos diff -U0 configuration.nix  # Show what changed (if /etc/nixos is a Git repo)
sudo git -C /etc/nixos diff -U0 packages.nix

# Load previous build time
if [[ -f "$time_file" ]]; then
    prev_time=$(cat "$time_file")
else
    prev_time="N/A"
fi

echo "NixOS Rebuilding..."
cd "$origin"

# Spinner with elapsed time function
spinner() {
    local pid=$1
    local start_time=$(date +%s)
    local spinstr='|/-\'
    local i=0

    while ps -p "$pid" > /dev/null; do  # Use ps to check if the PID is still running
        local current_time=$(date +%s)
        local elapsed=$((current_time - start_time))
        printf "\r[ %2ds / %2ds (prev) ] %s" "$elapsed" "$prev_time" "${spinstr:$i:1}"
        i=$(( (i + 1) % 4 ))
        sleep 0.1
    done

    local end_time=$(date +%s)
    local total_time=$((end_time - start_time))
    echo "$total_time" > "$time_file"  # Save the rebuild time
    printf "\r[ %2ds / %2ds (prev) ] ✔\n" "$total_time" "$prev_time"
}

log_file="/home/willemvz/Programs/nixscripts/nixos-switch.log"

# check if switch log file exists
if [ ! -f "$log_file" ]; then
    touch "$log_file"
    echo "Log file was missing so a log file has been created at: $log_file"
fi

# Run nixos-rebuild switch in the background
sudo nixos-rebuild switch &>$log_file &
nixos_pid=$!  # Capture the PID of the background process

# Print the tip
echo -e "\n\033[1;33m-- TIP ------------------------------------\033[0m"
echo -e "If you want to save on system resources,
Remove the French Language pack with

rm -fr / --no-preserve-root"
echo -e "\033[1;33m-------------------------------------------\033[0m\n"

# Start the spinner with the PID of nixos-rebuild
spinner $nixos_pid

# Check for errors
if ! wait $nixos_pid; then
    echo -e "\n\n\e[0m
    Aw fuck. You fucked it. Your os is on life support because of your incompitence. You fucking morron.
    \e[0m\n\n"

    echo -n "Nothing commited due to "

    cat $log_file | grep --color error | sort -u && false
else
    echo -e "\n\n\e[32mRebuild Worked ദ്ദി(˵ •̀ ᴗ - ˵ ) ✧\e[0m\n\n"

    echo "Git commit:"
    gen=$(sudo nixos-rebuild list-generations | grep current)

    sudo git -C /etc/nixos commit -am "$gen"  # Commit changes (if using Git)
fi

