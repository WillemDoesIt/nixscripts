#!/usr/bin/env bash
set -e
trap 'echo "‚ùå Error encountered! Check nixos-switch.log for details." >&2' ERR

sudo nvim /etc/nixos/configuration.nix

if command -v alejandra &>/dev/null; then
    sudo alejandra /etc/nixos/configuration.nix &>/dev/null
else
    echo "‚ö†Ô∏è  Warning: Alejandra not found. Skipping formatting."
fi

if [ -d "/etc/nixos/.git" ]; then
    sudo git -C /etc/nixos diff -U0 configuration.nix
else
    echo "‚ö†Ô∏è  Warning: /etc/nixos is not a Git repository. Skipping Git operations."
fi

echo "üîÑ NixOS Rebuilding..."
logfile=$(mktemp)
sudo nixos-rebuild switch &>"$logfile" || (grep --color error "$logfile" && rm "$logfile" && false)
rm "$logfile"

gen=$(sudo nixos-rebuild list-generations --json | jq -r '.generations[] | select(.current).number')

if [ -d "/etc/nixos/.git" ]; then
    if ! sudo nixos-rebuild dry-run | grep -q "upgrading"; then
        echo "‚ö†Ô∏è  No system changes detected. Skipping commit."
        exit 0
    fi
    sudo git -C /etc/nixos commit -am "NixOS Generation $gen"
fi
