#!/usr/bin/env bash
set -e

origin=$(pwd)
time_file="/home/willemvz/Programs/nixscripts/nixos-rebuild-time.txt"

cd /etc/nixos

sudo -E nvim packages.nix # Edit config with sudo

sudo alejandra /etc/nixos/configuration.nix &>/dev/null  # Format it

sudo git -C /etc/nixos diff -U0 configuration.nix  # Show what changed (if /etc/nixos is a Git repo)
sudo git -C /etc/nixos diff -U0 packages.nix

# Load previous build time
if [[ -f "$time_file" ]]; then
    prev_time=$(cat "$time_file")
else
    prev_time="N/A"
fi

echo "NixOS Rebuilding..."
cd "$origin"

# Spinner with elapsed time function
spinner() {
    local pid=$1
    local start_time=$(date +%s)
    local spinstr='|/-\'
    local i=0

    while kill -0 "$pid" 2>/dev/null; do
        local current_time=$(date +%s)
        local elapsed=$((current_time - start_time))
        printf "\r[ %2ds / %2ds (prev) ] %s" "$elapsed" "$prev_time" "${spinstr:$i:1}"
        i=$(( (i + 1) % 4 ))
        sleep 0.1
    done

    local end_time=$(date +%s)
    local total_time=$((end_time - start_time))
    echo "$total_time" > "$time_file"  # Save the rebuild time
    printf "\r[ %2ds / %2ds (prev) ] ✔\n" "$total_time" "$prev_time"
}

log_file="/home/willemvz/Programs/nixscripts/nixos-switch.log"

# check if switch log file exists
if [ ! -f "$log_file" ]; then    
    touch "$log_file"
    echo "Log file was missing so a log file has been created at: $log_file"
fi

# Run nixos-rebuild switch in the background
sudo nixos-rebuild switch &>$log_file &

# Start the spinner with the PID of nixos-rebuild
spinner $!

# Check for errors
if ! wait $!; then

    echo -e "\n\n\e[31mRebuild Failed ; _ ; \e[0m\n\n"

    echo -n "Nothing commited due to "

    cat $log_file | grep --color error | sort -u && false
else
    echo -e "\n\n\e[32mRebuild Worked ദ്ദി(˵ •̀ ᴗ - ˵ ) ✧\e[0m\n\n"

    echo "Git commit:"
    gen=$(sudo nixos-rebuild list-generations | grep current)

    sudo git -C /etc/nixos commit -am "$gen"  # Commit changes (if using Git)
fi
